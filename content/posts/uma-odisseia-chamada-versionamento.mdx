---
title: Uma odisseia chamada versionamento
description: Atualizando o react-native da vers√£o 0.68.2 para 0.72.4
date: "2023-09-16"
---

Ea√≠, tudo bem? Espero que sim. Recomendo que pegue um caf√© por qu√™ o t√≠tulo n√£o √© odisseia por acaso.

Recentemente enquanto escrevo esse texto, passei por uma situa√ß√£o muito comum na vida de qualquer desenvolvedor: atualizar um projeto parado a alguns meses e lidar com a atualiza√ß√£o e versionamento de pacotes.
Por√©m, eu n√£o contava que esse processo seria mais pesado do que eu imaginava.
E como forma de me ajudar a organizar, utilizei o bloco de notas pra ir criando uma 'linha do tempo' de tentativas e links √∫teis durante o processo.
Antes de mostrar pra voc√™s essas anota√ß√µes, quero deixar todo mundo contextualizado: <br/>

- <strong>Objetivo</strong>: Subir uma nova vers√£o de um app feito em React Native para a Play Store
- <strong>Entrave</strong>: A Google n√£o aceitava o API Level abaixo de 33 (ou Android abaixo de 13)
- <strong>Solu√ß√£o</strong>: Atualizar um projeto feito em React Native da vers√£o 0.68.2 para 0.72.4
- <strong>Nomenclatura</strong>: Vou tratar o nome do app como 'updatedApp'

obs: cada teste de build ou start era algo em torno de 15-20 minutos, ou seja, 3-4 builds por hora, 24 tentativas por dia (em um dia de 8 horas trabalhadas)<br/>

Sabendo disso, bora l√°:
<hr/>

## Atualizando com react-native-upgrade

Depois de pesquisar como adequar meu app a esse novo Android, cheguei a algumas solu√ß√µes mas n√£o consegui fugir de ter que atualizar o pr√≥prio `react-native`.
Talvez houvesse outras formas de resolver, mas a decis√£o foi tomada, ent√£o vamos seguir.

Rodei um `react-native-upgrade` e como sabia que teria que atualizar uma s√©rie de arquivos nativos, utilizei o [Upgrade helper](https://react-native-community.github.io/upgrade-helper/?from=0.68.2&to=0.72.4) como guia. 
Essa ferramenta foi uma m√£o na roda, obrigado comunidade üôè<br/>

Depois de implementar as muitas corre√ß√µes arquivo por aquivo, o primeiro erro que surgiu foi esse: <br/>
```html
    Failed to apply plugin 'com.android.internal.version-check'.
- Minimum supported Gradle version is 7.5. Current version is 7.3.3.
- If using the gradle wrapper, try editing the distributionUrl in /updated-app/android/gradle/wrapper/gradle-wrapper.properties to gradle-7.5-all.zip
```

Ap√≥s corrigir me guiando pelo pr√≥prio Upgrade Helper e com a atualiza√ß√£o manual do [expo-modules](https://docs.expo.dev/bare/installing-expo-modules/)
surge esse outro problema: <br/>
```html
Uncaught Error Error: [ios.xcodeproj]: withIosXcodeprojBaseMod: Cannot find module './parse'
Require stack:
- ../.npm/_npx/d80a5a2fd0b43bdc/node_modules/install-expo-modules/build/index.js
```

Depois dessa corre√ß√£o(que n√£o lembro como foi), surge outro:
>Build file '.../updated-app/node_modules/expo-application/android/build.gradle' line: 40

Como esse foi mais espec√≠fico, a corre√ß√£o foi mais f√°cil, me levando a esse aviso: `classifier undefined`
Durante a pesquisa encontrei esse cara aqui pra resolver o problema [https://github.com/expo/fyi/blob/main/expo-modules-gradle8-migration.md](https://github.com/expo/fyi/blob/main/expo-modules-gradle8-migration.md)<br/>

## Nesse ponto tive que pedir ajuda pro Doutor
Como o √∫ltimo fix n√£o rolou, ent√£o usei o `npx expo-doctor` (lista exatamente as libs que precisam ser atualizadas)<br/>

Rodei o comando onde o pr√≥prio expo-doctor avalia e instala as libs de acordo (`expo doctor --fix-dependencies`)<br/>

Novo erro:
> A problem occurred configuring project ':app'. Cannot query the value of extension 'react' property 'entryFile' because it has no value available.<br/>

Junto a esse erro, ao rodar o expo-doctor ele apontava que eu estava utilizando uma vers√£o x do `@expo/config-plugins` e queria a vers√£o y, sendo que eu tava com a versao x<br/>

Depois de perguntar pro chatGPT como resolver essa quest√£o do @expo/config-plugins, exclu√≠ a `node_modules` e instalei tudo de novo com yarn (nada aconteceu feijoada)<br/>

Ap√≥s debugar com `./gradlew assembleRelease --scan`, vi que era algo em volta desse `expo-updates-gradle-plugin`.<br/>

Insight: entendi, a vers√£o do `@expo/config-plugin` que tenho no projeto ta correta, por√©m, outras libs que possuem ela como depend√™ncia est√£o usando vers√µes anteriores<br/>

Atualizei a vers√£o das depend√™ncias de cada uma das depend√™ncias no `yarn.lock` e o `expo-doctor` apontou mais nada, por√©m, segue o mesmo erro ao rodar `yarn android`
> (Cannot query the value of extension 'react' property 'entryFile' because it has no value available)

Entrei no arquivo `android/app/build.gradle` e descomentei a linha com o 'entryFile' e quaaaase foi (o build foi em 100% da configura√ß√£o mas crashou na execu√ß√£o)

## Atualizando com o expo update
Descobri que tava fazendo todo esse processo pelo `react-native upgrade`, que tende a ser mais complicado mesmo [https://www.youtube.com/watch?v=Y9ihngV85w8](https://www.youtube.com/watch?v=Y9ihngV85w8) ent√£o bora tentar com o `expo update`.<br/>

Clonei novamente o projeto pra deixar as duas tentativas (expo update e react native upgrade) em pastas diferentes.<br/>

Depois de rodar o `expo update`, rodei um `npx expo install --fix` e retornei pro mesmo problema com o `@expo/config-plugins`<br/>

Observa√ß√£o: muito provavelmente s√£o esses caras que estavam ferrando o rol√™<br/>
- react-native-iap: "^12.10.7"
- @react-native-firebase/app: "^16.4.6"

Ap√≥s avaliar o c√≥digo, percebi que a lib `react-native-iap`, ent√£o comentei todas as men√ß√µes a essa lib na codebase e a build funcionou.<br/>

Agora ao rodar `yarn android` para desenvolvedor, temos isso:
```html
    1.Error: No Firebase App '[DEFAULT]' has been created - call firebase.initializeApp(), js engine: hermes
    2.Invariant Violation: "updatedapp" has not been registered. This can happen if: Metro (the local dev server) is run from the wrong folder. Check if Metro is running, stop it and restart it in the current project.
    3.A module failed to load due to an error and `AppRegistry.registerComponent` wasn't called., js engine: hermes
```

Dos erros acima, o problema real √© o n√∫mero 2, onde o nome do app oficialmente √© `com.Updatedapp` e to trabalhando com `com.updatedapp` (acabei n√£o percebendo isso nos primeiros passos do update)
e pra resolver isso, segui esse post (https://stackoverflow.com/questions/74774494/how-to-change-android-package-name-in-react-native-0-70-and-above)[https://stackoverflow.com/questions/74774494/how-to-change-android-package-name-in-react-native-0-70-and-above]<br/>

Ap√≥s atualizar o package name nesses locais, tive muitos problemas envolvendo o updatedapp.BuildConfig, preciso descobrir onde ele ta ou como gerar ele. Tentei com.updatedapp.BuildConfig no `MainApplication.java` e rolou o `./gradlew assembleRelease`. Agora, ao rodar a aplica√ß√£o com `yarn android`, essa √© mensagem:<br/>

```html
- Invariant Violation: "updatedapp" has not been registered. This can happen if:
* Metro (the local dev server) is run from the wrong folder. Check if Metro is running, stop it and restart it in the current project.
```

Depois de muita pesquisa, foquei na finaleira desse post aqui <a href="https://github.com/wix/react-native-navigation/issues/5520">https://github.com/wix/react-native-navigation/issues/5520</a> eu fui mudando os nomes na `MainActivity.java`

## A f√© come√ßa a ser abalada
J√° √© o quinto dia debugando isso, o foco j√° n√£o √© mais o mesmo.<br/>

J√° sem op√ß√µes e sabendo que tinha resolver essa quest√£o do `packageName`, decidi olhar o c√≥digo do app de produ√ß√£o e comparar com o app que estava atualizando.<br/>

Achei uma diferen√ßa no `MainActivity.java` da minha vers√£o, onde estava como "updatedApp" mas era s√≥ manter "main":
```java
    @Override
    protected String getMainComponentName() {
        return "main";
    }
```

tive que adicionar mais um bloco no `andrid/app/build.gradle` pois tava gerando os bundles com as configura√ß√µes de debug, e como meu app √© assinado diretamente pela loja e n√£o uma key f√≠sica, criei mais um bloco de configura√ß√µes para bundles de produ√ß√£o.

e funcionou.

## Hora de submeter o app pra Loja

Sim, teve mais erros. A loja ainda apontava para um erro: "N√£o √© poss√≠vel lan√ßar esta vers√£o porque ela n√£o permite que os usu√°rios existentes fa√ßam a atualiza√ß√£o para os novos pacotes de apps."

Pra resolver isso, bastou eu ver qual a √∫ltima vers√£o do app eu tinha submetido para a loja e corrigir colocando uma vers√£o maior no `build.gradle`.

Agora sim, resolvido!

## Conclus√£o

Essa brincadeira levou 4 dias e meio, portanto, nunca subestimem uma atualiza√ß√£o. Espero ter conseguido mostrar o lado n√£o t√£o glamuroso da programa√ß√£o e tamb√©m como foi surgindo a resolu√ß√£o de cada problema.


Espero ter conseguido ajudar em algo,
abra√ßo!